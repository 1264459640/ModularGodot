# 场景系统技术文档

## 1. 核心功能

提供场景切换和过渡效果管理服务，主要功能包括：

- 场景加载和切换
- 过渡效果管理（淡入淡出等）
- 自定义过渡效果支持
- 过渡状态监控和事件通知

## 2. 基本使用

### 服务获取

通过依赖注入获取ISceneManagerService实例：

```csharp
public class MyService(ISceneManagerService sceneManager)
{
    // 使用sceneManager访问场景系统
}
```

### 场景切换

```csharp
// 使用过渡效果类型的场景切换方式
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.Fade, 1.0f);     // 淡入淡出效果
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.None, 0f);       // 无过渡效果
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.Slide, 0.8f);    // 滑动效果（暂时使用淡入淡出实现）
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.Scale, 1.2f);    // 缩放效果（暂时使用淡入淡出实现）

// 快速切换（无过渡）
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.None);

// 默认淡入淡出效果
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.Fade);
```

### 过渡效果控制

```csharp
// 通过仓储接口直接控制过渡效果
// 淡出效果（出场）
await sceneManagerRepo.FadeOut(1.0f);

// 淡入效果（入场）
await sceneManagerRepo.FadeIn(1.0f);

// 执行指定类型的过渡效果
await sceneManagerRepo.ExecuteTransitionEffect(TransitionEffectType.Fade, 1.0f, true);  // 入场效果
await sceneManagerRepo.ExecuteTransitionEffect(TransitionEffectType.Fade, 1.0f, false); // 出场效果

// 中断当前过渡
sceneManagerRepo.InterruptTransition();
```

### 自定义过渡效果

```csharp
// 创建自定义过渡效果需要实现ITransitionEffect接口或继承BaseTransitionEffect
public class CustomTransitionEffect : BaseTransitionEffect
{
    public override async GDTask Execute(TransitionSystem system)
    {
        // 实现自定义过渡效果逻辑
    }
    
    public override void Interrupt()
    {
        // 实现中断逻辑
    }
}

// 通过TransitionEffectRegistry注册自定义效果
var registry = new TransitionEffectRegistry();
registry.RegisterEffect(TransitionEffectType.Custom, isEntering => new CustomTransitionEffect());
```

## 3. 过渡效果类型

### 过渡效果类型枚举

系统定义了以下过渡效果类型：

```csharp
public enum TransitionEffectType
{
    None,     // 无过渡效果
    Fade,     // 淡入淡出效果
    Slide,    // 滑动效果（暂时使用淡入淡出实现）
    Scale,    // 缩放效果（暂时使用淡入淡出实现）
    Rotate,   // 旋转效果（暂时使用淡入淡出实现）
    Custom    // 自定义效果（暂时使用淡入淡出实现）
}
```

### 内置效果实现

```csharp
// 内置效果
// 1. FadeTransitionEffect - 淡入淡出效果
//    构造函数参数：bool isEntering - 是否为入场效果（true=淡入，false=淡出）
var fadeOutEffect = new FadeTransitionEffect(false); // 淡出效果
var fadeInEffect = new FadeTransitionEffect(true);   // 淡入效果

// 自定义效果需实现ITransitionEffect接口或继承BaseTransitionEffect
public class CustomTransitionEffect : BaseTransitionEffect
{
    public override async GDTask Execute(TransitionSystem system)
    {
        // 实现自定义过渡效果逻辑
    }
    
    public override void Interrupt()
    {
        // 实现中断逻辑
    }
}
```

## 4. 场景配置

### 场景路径配置

通过SceneConfig配置场景资源路径：

```csharp
public class SceneConfig
{
    public const string FarmScene = "res://Scenes/Games/Farm.tscn";
    // 可以添加更多场景路径常量
    // public const string MainMenuScene = "res://Scenes/UI/MainMenu.tscn";
    // public const string BattleScene = "res://Scenes/Games/Battle.tscn";
}
```

## 5. 过渡状态

系统定义了以下过渡状态：

```csharp
public enum TransitionState
{
    Idle,        // 空闲状态
    Running,     // 运行中
    Paused,      // 暂停中
    Completed,   // 已完成
    Interrupted  // 已中断
}
```

## 6. 最佳实践

1. **场景切换**：
   - 使用`ChangeScene`方法进行场景切换，自动处理过渡效果
   - 为重要场景切换设置适当的过渡时间，提升用户体验
   - 场景切换前保存必要的游戏状态
   - **避免硬编码路径**：调用场景相关方法时，应使用`SceneConfig`中的常量获取路径
   - **选择合适的过渡效果**：使用`TransitionEffectType`枚举选择合适的过渡效果类型
   - **设置合理的过渡时间**：根据场景复杂度和用户体验需求设置过渡时间

2. **自定义效果**：
   - 继承`BaseTransitionEffect`创建自定义效果
   - 在`Execute`方法中实现效果逻辑
   - 在`Interrupt`和`Dispose`方法中正确清理资源

3. **过渡效果使用**：
   - 使用`ExecuteTransitionEffect`方法执行指定的过渡效果
   - 合理设置过渡时间，确保视觉体验流畅
   - 根据场景切换需求选择合适的效果类型

```csharp
// 推荐的过渡效果使用示例
// 出场效果（淡出）
await sceneManagerRepo.ExecuteTransitionEffect(TransitionEffectType.Fade, 0.8f, false);
// 加载新场景
await sceneManager.ChangeScene(SceneConfig.FarmScene, TransitionEffectType.Fade, 0.8f);
```

4. **配置集中化**：
   - 在SceneConfig中统一管理场景路径
   - 避免硬编码路径字符串
   - 调用方法时使用SceneConfig中的常量获取路径

## 7. 注意事项

- 所有场景路径必须在SceneConfig中配置
- **避免硬编码路径**：调用场景相关方法时，应使用`SceneConfig`中的常量获取路径，而不是直接写入路径字符串
- 过渡效果需要正确设置CanvasLayer和ColorRect
- 淡入淡出效果依赖于ShaderMaterial，确保材质正确配置
- 过渡效果执行是异步的，需要使用await等待完成
- 场景切换时会自动处理旧场景的释放
- 过渡效果中断后需要手动清理资源
- 自定义效果应实现正确的资源释放逻辑