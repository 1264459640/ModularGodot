# ç¤ºä¾‹ä»£ç ä¸è‡ªåŠ¨æ³¨å†Œè§„èŒƒ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ•´ç†äº†é¡¹ç›®ä¸­çš„ç¤ºä¾‹ä»£ç å’ŒåŸºäºAutofacçš„è‡ªåŠ¨æ³¨å†Œè§„åˆ™ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨DDDæ¶æ„ä¸‹å®ç°èŠ‚ç‚¹çš„ä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

## ğŸ“ å‘½åè§„èŒƒæ€»ç»“

### è¡¨ç¤ºå±‚ (Scripts/Tests/Examples)
- **èŠ‚ç‚¹ç±»**: `TestNode`, `TestManager`
- **æ¥å£**: `ITestNode`, `ITestManager`
- **ç‰¹æ€§**: ä½¿ç”¨ `[GlobalClass]` æ ‡è®°å¯åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨çš„ç±»

### åº”ç”¨å±‚ (TO.Apps.Services)
- **èŠ‚ç‚¹æœåŠ¡**: `NodeTestNodeService` (ä»¥ `Node` å¼€å¤´)
- **æ™®é€šæœåŠ¡**: `XxxService` (ä¸ä»¥ `Node` å¼€å¤´)
- **âš ï¸ é‡è¦æç¤º**: éèŠ‚ç‚¹æœåŠ¡å¦‚æœæ„é€ å‡½æ•°ä¸­éœ€è¦æ‰§è¡Œé€»è¾‘ä»£ç ï¼Œå¿…é¡»åœ¨ `TO.Contexts\Contexts.cs` ä¸­æ‰‹åŠ¨è§£æè¯¥æœåŠ¡ï¼Œå¦åˆ™æ„é€ å‡½æ•°é€»è¾‘ä¸ä¼šè¢«æ‰§è¡Œ
- **ğŸ”´ èŠ‚ç‚¹æœåŠ¡å±‚çº§é™åˆ¶**: èŠ‚ç‚¹åªæœ‰åº”ç”¨å±‚æœåŠ¡ï¼ŒèŠ‚ç‚¹ç®¡ç†å™¨æ‰å¯ä»¥åŒæ—¶æœ‰é¢†åŸŸå±‚æœåŠ¡å’Œåº”ç”¨å±‚æœåŠ¡ã€‚å¦‚æœåœ¨é¢†åŸŸå±‚åˆ›å»ºèŠ‚ç‚¹æœåŠ¡å°†ä¸ä¼šè‡ªåŠ¨æ³¨å†Œè¿›å®¹å™¨

### åŸºç¡€è®¾æ–½å±‚ (TO.Infras.Repositories)
- **èŠ‚ç‚¹ä»“å‚¨**: `NodeTestNodeRepo` (å¯¹åº”èŠ‚ç‚¹æœåŠ¡)
- **å•ä¾‹ä»“å‚¨**: `TestManagerRepo` (å¯¹åº”å•ä¾‹ç®¡ç†å™¨)
- **æ™®é€šä»“å‚¨**: `XxxRepo` (ä¸ä»¥ç‰¹æ®Šå‰ç¼€å¼€å¤´)

### é¢†åŸŸå±‚æ¥å£ (TO.Domains.Models.Repositories.Abstractions)
- **èŠ‚ç‚¹ä»“å‚¨æ¥å£**: `INodeTestNodeRepo`
- **å•ä¾‹ä»“å‚¨æ¥å£**: `ITestManagerRepo`
- **èŠ‚ç‚¹æ¥å£**: `ITestNode`, `ITestManager`

## ğŸ”§ è‡ªåŠ¨æ³¨å†Œè§„åˆ™

### NodeRegister - å•ä¾‹èŠ‚ç‚¹æ³¨å†Œå™¨

**æ–‡ä»¶ä½ç½®**: `TO.Domains.Models.Repositories.Abstractions\Nodes\NodeRegister.cs`

```csharp
using TO.Domains.Models.Repositories.Abstractions.Core.AudioSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.SceneSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.SerializationSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.UISystem;
using TO.Domains.Models.Repositories.Abstractions.Test.Examples;
using TO.GodotNodes.Abstractions;
using TO.Nodes.Abstractions.Nodes.Singletons;
using TO.Nodes.Abstractions.Tests.Examples;

namespace TO.Domains.Models.Repositories.Abstractions.Nodes;

public class NodeRegister(
    ITestManagerRepo testManagerRepo,
    IUIManagerRepo uiManagerRepo, 
    IAudioManagerRepo audioManagerRepo, 
    ISaveManagerRepo saveManagerRepo,
    ISceneManagerRepo sceneManagerRepo)
{
    public bool Register<T>(T node) where T : INode
    {
        return node switch
        {
            // å•ä¾‹ç®¡ç†å™¨æ³¨å†Œ
            ITestManager testManager => testManagerRepo.Register(testManager),
            IUIManager uiManager => uiManagerRepo.Register(uiManager),
            IAudioManager audioManager => audioManagerRepo.Register(audioManager),
            ISaveManager saveManager => saveManagerRepo.Register(saveManager),
            ISceneManager sceneManager => sceneManagerRepo.Register(sceneManager),
            _ => throw new ArgumentException($"æš‚ä¸æ”¯æŒçš„å•ä¾‹èŠ‚ç‚¹ï¼š{typeof(T).Name}")
        };
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- **ç»Ÿä¸€æ³¨å†Œå…¥å£**: ä¸ºæ‰€æœ‰å•ä¾‹ç®¡ç†å™¨èŠ‚ç‚¹æä¾›ç»Ÿä¸€çš„æ³¨å†Œæ¥å£
- **ç±»å‹å®‰å…¨**: é€šè¿‡æ³›å‹å’Œæ¨¡å¼åŒ¹é…ç¡®ä¿ç±»å‹å®‰å…¨
- **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥æ‰€æœ‰éœ€è¦çš„ä»“å‚¨æ¥å£
- **é”™è¯¯å¤„ç†**: å¯¹ä¸æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹æŠ›å‡ºæ˜ç¡®çš„å¼‚å¸¸ä¿¡æ¯

**ä½¿ç”¨åœºæ™¯**:
- å½“å•ä¾‹ç®¡ç†å™¨èŠ‚ç‚¹ï¼ˆå¦‚ UIManagerã€AudioManager ç­‰ï¼‰éœ€è¦æ³¨å†Œåˆ°ç³»ç»Ÿæ—¶
- åœ¨ `Contexts.Instance.RegisterNode<T>()` å†…éƒ¨è¢«è°ƒç”¨
- ç¡®ä¿æ‰€æœ‰å•ä¾‹èŠ‚ç‚¹éƒ½èƒ½æ­£ç¡®æ³¨å†Œåˆ°å¯¹åº”çš„ä»“å‚¨ä¸­

**æ‰©å±•æ­¥éª¤**:
1. åœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ æ–°çš„ä»“å‚¨æ¥å£å‚æ•°
2. åœ¨ `Register` æ–¹æ³•çš„ switch è¡¨è¾¾å¼ä¸­æ·»åŠ æ–°çš„ case åˆ†æ”¯
3. ç¡®ä¿æ–°çš„ä»“å‚¨æ¥å£å’Œå®ç°å·²åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œ

### NodeModule - èŠ‚ç‚¹æœåŠ¡è‡ªåŠ¨æ³¨å†Œ

**æ–‡ä»¶ä½ç½®**: `TO.Contexts\NodeModule.cs`

```csharp
using System.Reflection;
using Autofac;
using Module = Autofac.Module;

namespace Contexts;

public class NodeModule: Module
{
    protected override void Load(ContainerBuilder builder)
    {
        var appServicesAssembly = Assembly.Load("TO.Apps.Services");
        var repoAssembly = Assembly.Load("TO.Infras.Repositories");
        var servicesTypes = appServicesAssembly.GetTypes()
            .Where(t => t.Name.StartsWith("Node"));

        foreach (var commandType in servicesTypes)
        {
            var repoTypeName = commandType.Name.Replace("Service", "Repo");
            var repoType = repoAssembly.GetTypes().FirstOrDefault(t => 
                t.Name == repoTypeName
            );
            if (repoType != null)
            {
                builder.RegisterType(commandType)
                    .AsSelf()
                    .InstancePerMatchingLifetimeScope(repoType);
            }
        }
    }
}
```

**æ³¨å†Œè§„åˆ™**:
1. **å‘½åçº¦å®š**: æœåŠ¡ç±»åå¿…é¡»ä»¥ `Node` å¼€å¤´
2. **é…å¯¹è§„åˆ™**: `NodeXxxService` å¯¹åº” `NodeXxxRepo`
3. **ç”Ÿå‘½å‘¨æœŸ**: ä½¿ç”¨ `InstancePerMatchingLifetimeScope` ä¸å¯¹åº”ä»“å‚¨ç»‘å®š
4. **ç¨‹åºé›†æ‰«æ**: è‡ªåŠ¨æ‰«æ `TO.Apps.Services` å’Œ `TO.Infras.Repositories` ç¨‹åºé›†
5. **ğŸ”´ å±‚çº§é™åˆ¶**: ä»…æ‰«æåº”ç”¨å±‚(`TO.Apps.Services`)ä¸­çš„èŠ‚ç‚¹æœåŠ¡ï¼Œé¢†åŸŸå±‚ä¸­çš„èŠ‚ç‚¹æœåŠ¡ä¸ä¼šè¢«è‡ªåŠ¨æ³¨å†Œ

### SingleModule - å•ä¾‹æœåŠ¡è‡ªåŠ¨æ³¨å†Œ

**æ–‡ä»¶ä½ç½®**: `TO.Contexts\SingleModule.cs`

**æ³¨å†Œè§„åˆ™**:
1. **åº”ç”¨æœåŠ¡**: ä¸ä»¥ `Node` å¼€å¤´çš„ç±»å‹
2. **é¢†åŸŸæœåŠ¡**: ä»¥ `Service` ç»“å°¾ä¸”ä¸ä»¥ `Node` å¼€å¤´çš„ç±»å‹
3. **ä»“å‚¨æœåŠ¡**: ä¸ä»¥ `Node`ã€`Base`ã€`Singleton` å¼€å¤´çš„ç±»å‹
4. **æ¥å£åŒ¹é…**: è‡ªåŠ¨åŒ¹é… `XxxService` ä¸ `IXxxService` æ¥å£
5. **ç”Ÿå‘½å‘¨æœŸ**: æ‰€æœ‰æœåŠ¡æ³¨å†Œä¸º `SingleInstance`
6. **âš ï¸ æ„é€ å‡½æ•°é€»è¾‘**: éèŠ‚ç‚¹æœåŠ¡å¦‚æœæ„é€ å‡½æ•°åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œéœ€è¦åœ¨ `Contexts.cs` ä¸­æ‰‹åŠ¨è§£æä»¥ç¡®ä¿é€»è¾‘æ‰§è¡Œ

## ğŸ—ï¸ æ¶æ„å±‚æ¬¡ç¤ºä¾‹

### è¡¨ç¤ºå±‚ (Presentation Layer)

#### æ™®é€šèŠ‚ç‚¹ç¤ºä¾‹ - TestNode

**æ–‡ä»¶ä½ç½®**: `Scripts\Tests\Examples\TestNode.cs`

```csharp
using Autofac;
using Contexts;
using Godot;
using inFras.Tests.Examples;
using TO.Nodes.Abstractions.Tests.Examples;

namespace demo.Tests.Examples;

[GlobalClass]
public partial class TestNode : Node, ITestNode
{
    public ILifetimeScope? NodeScope { get; set; }
    
    public override void _Ready()
    {
        NodeScope = NodeContexts.Instance.RegisterNode<ITestNode, NodeTestNodeRepo>(this);
    }
}
```

**å…³é”®ç‰¹æ€§**:
- ç»§æ‰¿è‡ª `Node` å¹¶å®ç° `ITestNode` æ¥å£
- ä½¿ç”¨ `[GlobalClass]` ç‰¹æ€§æ ‡è®°
- åœ¨ `_Ready()` æ–¹æ³•ä¸­æ³¨å†ŒèŠ‚ç‚¹åˆ°ä¾èµ–æ³¨å…¥å®¹å™¨
- é€šè¿‡ `NodeContexts.Instance.RegisterNode` è¿›è¡Œæ³¨å†Œ

#### å•ä¾‹ç®¡ç†å™¨ç¤ºä¾‹ - TestManager

**æ–‡ä»¶ä½ç½®**: `Scripts\Tests\Examples\TestManager.cs`

```csharp
using Autofac;
using Godot;
using TO.Nodes.Abstractions.Tests.Examples;

namespace demo.Tests.Examples;

public partial class TestManager : Node, ITestManager
{
    public ILifetimeScope? NodeScope { get; set; }
    
    public override void _Ready()
    {
        Contexts.Contexts.Instance.RegisterNode<ITestManager>(this);
    }
}
```

**å…³é”®ç‰¹æ€§**:
- å•ä¾‹ç®¡ç†å™¨èŠ‚ç‚¹çš„å®ç°æ¨¡å¼
- ä½¿ç”¨ `Contexts.Contexts.Instance.RegisterNode` è¿›è¡Œå•ä¾‹æ³¨å†Œ
- ä¸éœ€è¦æŒ‡å®šå…·ä½“çš„ä»“å‚¨ç±»å‹

### åº”ç”¨å±‚ (Application Layer)

#### èŠ‚ç‚¹æœåŠ¡ç¤ºä¾‹ - NodeTestNodeService

**æ–‡ä»¶ä½ç½®**: `TO.Apps.Services\Tests\Examples\NodeTestNodeService.cs`

```csharp
using Godot;

namespace TO.Apps.Services.Tests.Examples;

public class NodeTestNodeService
{
    public NodeTestNodeService()
    {
        GD.Print("NodeTestNodeService: Initialized");
    }
}
```

**å…³é”®ç‰¹æ€§**:
- ç±»åä»¥ `Node` å¼€å¤´ï¼Œç¬¦åˆè‡ªåŠ¨æ³¨å†Œè§„åˆ™
- ç®€å•çš„æœåŠ¡å®ç°ï¼Œå¯åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œåˆå§‹åŒ–
- ä¼šè¢« `NodeModule` è‡ªåŠ¨æ³¨å†Œ

### åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)

#### æ™®é€šèŠ‚ç‚¹ä»“å‚¨ç¤ºä¾‹ - NodeTestNodeRepo

**æ–‡ä»¶ä½ç½®**: `TO.Infras.Repositories\Tests\Examples\NodeTestNodeRepo.cs`

```csharp
using inFras.Bases;
using TO.Domains.Models.Repositories.Abstractions.Test.Examples;
using TO.Events.Contexts;
using TO.Nodes.Abstractions.Tests.Examples;

namespace inFras.Tests.Examples;

public class NodeTestNodeRepo : NodeRepo<ITestNode>, INodeTestNodeRepo
{
    public NodeTestNodeRepo(ITestNode main)
    {
        Node = main;
        Register();
        ContextEvents.TriggerRegisterNode(this, ConfigureNodeScope);
    }
}
```

**å…³é”®ç‰¹æ€§**:
- ç»§æ‰¿è‡ª `NodeRepo<ITestNode>`
- å®ç°å¯¹åº”çš„ä»“å‚¨æ¥å£ `INodeTestNodeRepo`
- æ„é€ å‡½æ•°æ¥æ”¶èŠ‚ç‚¹å®ä¾‹å¹¶è¿›è¡Œæ³¨å†Œ
- è§¦å‘ä¸Šä¸‹æ–‡äº‹ä»¶è¿›è¡ŒèŠ‚ç‚¹ä½œç”¨åŸŸé…ç½®

#### å•ä¾‹èŠ‚ç‚¹ä»“å‚¨ç¤ºä¾‹ - TestManagerRepo

**æ–‡ä»¶ä½ç½®**: `TO.Infras.Repositories\Tests\Examples\TestManagerRepo.cs`

```csharp
using Godot;
using inFras.Bases;
using TO.Domains.Models.Repositories.Abstractions.Test.Examples;
using TO.Nodes.Abstractions.Tests.Examples;

namespace inFras.Tests.Examples;

public class TestManagerRepo : SingletonNodeRepo<ITestManager>, ITestManagerRepo
{
    protected override void Init()
    {
        base.Init();
        GD.Print("TestManagerRepo Init");
    }
}
```

**å…³é”®ç‰¹æ€§**:
- ç»§æ‰¿è‡ª `SingletonNodeRepo<ITestManager>`
- å®ç°å¯¹åº”çš„ä»“å‚¨æ¥å£ `ITestManagerRepo`
- é‡å†™ `Init()` æ–¹æ³•è¿›è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–
- å•ä¾‹æ¨¡å¼ç®¡ç†

## ğŸ”§ è‡ªåŠ¨æ³¨å†Œè§„åˆ™

### NodeRegister - å•ä¾‹èŠ‚ç‚¹æ³¨å†Œå™¨

**æ–‡ä»¶ä½ç½®**: `d:\GodotProjects\demo\TO.Domains.Models.Repositories.Abstractions\Nodes\NodeRegister.cs`

```csharp
using TO.Domains.Models.Repositories.Abstractions.Core.AudioSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.SceneSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.SerializationSystem;
using TO.Domains.Models.Repositories.Abstractions.Core.UISystem;
using TO.Domains.Models.Repositories.Abstractions.Test.Examples;
using TO.GodotNodes.Abstractions;
using TO.Nodes.Abstractions.Nodes.Singletons;
using TO.Nodes.Abstractions.Tests.Examples;

namespace TO.Domains.Models.Repositories.Abstractions.Nodes;

public class NodeRegister(
    ITestManagerRepo testManagerRepo,
    IUIManagerRepo uiManagerRepo, 
    IAudioManagerRepo audioManagerRepo, 
    ISaveManagerRepo saveManagerRepo,
    ISceneManagerRepo sceneManagerRepo)
{
    public bool Register<T>(T node) where T : INode
    {
        return node switch
        {
            // å•ä¾‹ç®¡ç†å™¨æ³¨å†Œ
            ITestManager testManager => testManagerRepo.Register(testManager),
            IUIManager uiManager => uiManagerRepo.Register(uiManager),
            IAudioManager audioManager => audioManagerRepo.Register(audioManager),
            ISaveManager saveManager => saveManagerRepo.Register(saveManager),
            ISceneManager sceneManager => sceneManagerRepo.Register(sceneManager),
            _ => throw new ArgumentException($"æš‚ä¸æ”¯æŒçš„å•ä¾‹èŠ‚ç‚¹ï¼š{typeof(T).Name}")
        };
    }
}
```

**æ ¸å¿ƒåŠŸèƒ½**:
- **ç»Ÿä¸€æ³¨å†Œå…¥å£**: ä¸ºæ‰€æœ‰å•ä¾‹ç®¡ç†å™¨èŠ‚ç‚¹æä¾›ç»Ÿä¸€çš„æ³¨å†Œæ¥å£
- **ç±»å‹å®‰å…¨**: é€šè¿‡æ³›å‹å’Œæ¨¡å¼åŒ¹é…ç¡®ä¿ç±»å‹å®‰å…¨
- **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥æ‰€æœ‰éœ€è¦çš„ä»“å‚¨æ¥å£
- **é”™è¯¯å¤„ç†**: å¯¹ä¸æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹æŠ›å‡ºæ˜ç¡®çš„å¼‚å¸¸ä¿¡æ¯

**ä½¿ç”¨åœºæ™¯**:
- å½“å•ä¾‹ç®¡ç†å™¨èŠ‚ç‚¹ï¼ˆå¦‚ UIManagerã€AudioManager ç­‰ï¼‰éœ€è¦æ³¨å†Œåˆ°ç³»ç»Ÿæ—¶
- åœ¨ `Contexts.Instance.RegisterNode<T>()` å†…éƒ¨è¢«è°ƒç”¨
- ç¡®ä¿æ‰€æœ‰å•ä¾‹èŠ‚ç‚¹éƒ½èƒ½æ­£ç¡®æ³¨å†Œåˆ°å¯¹åº”çš„ä»“å‚¨ä¸­

**æ‰©å±•æ­¥éª¤**:
1. åœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ æ–°çš„ä»“å‚¨æ¥å£å‚æ•°
2. åœ¨ `Register` æ–¹æ³•çš„ switch è¡¨è¾¾å¼ä¸­æ·»åŠ æ–°çš„ case åˆ†æ”¯
3. ç¡®ä¿æ–°çš„ä»“å‚¨æ¥å£å’Œå®ç°å·²åœ¨ DI å®¹å™¨ä¸­æ³¨å†Œ

### NodeModule - èŠ‚ç‚¹æœåŠ¡è‡ªåŠ¨æ³¨å†Œ

**æ–‡ä»¶ä½ç½®**: `d:\GodotProjects\demo\TO.Contexts\NodeModule.cs`

```csharp
using System.Reflection;
using Autofac;
using Module = Autofac.Module;

namespace Contexts;

public class NodeModule: Module
{
    protected override void Load(ContainerBuilder builder)
    {
        var appServicesAssembly = Assembly.Load("TO.Apps.Services");
        var repoAssembly = Assembly.Load("TO.Infras.Repositories");
        var servicesTypes = appServicesAssembly.GetTypes()
            .Where(t => t.Name.StartsWith("Node"));

        foreach (var commandType in servicesTypes)
        {
            var repoTypeName = commandType.Name.Replace("Service", "Repo");
            var repoType = repoAssembly.GetTypes().FirstOrDefault(t => 
                t.Name == repoTypeName
            );
            if (repoType != null)
            {
                builder.RegisterType(commandType)
                    .AsSelf()
                    .InstancePerMatchingLifetimeScope(repoType);
            }
        }
    }
}
```

**æ³¨å†Œè§„åˆ™**:
1. **å‘½åçº¦å®š**: æœåŠ¡ç±»åå¿…é¡»ä»¥ `Node` å¼€å¤´
2. **é…å¯¹è§„åˆ™**: `NodeXxxService` å¯¹åº” `NodeXxxRepo`
3. **ç”Ÿå‘½å‘¨æœŸ**: ä½¿ç”¨ `InstancePerMatchingLifetimeScope` ä¸å¯¹åº”ä»“å‚¨ç»‘å®š
4. **ç¨‹åºé›†æ‰«æ**: è‡ªåŠ¨æ‰«æ `TO.Apps.Services` å’Œ `TO.Infras.Repositories` ç¨‹åºé›†

### SingleModule - å•ä¾‹æœåŠ¡è‡ªåŠ¨æ³¨å†Œ

**æ–‡ä»¶ä½ç½®**: `d:\GodotProjects\demo\TO.Contexts\SingleModule.cs`

**æ³¨å†Œè§„åˆ™**:
1. **åº”ç”¨æœåŠ¡**: ä¸ä»¥ `Node` å¼€å¤´çš„ç±»å‹
2. **é¢†åŸŸæœåŠ¡**: ä»¥ `Service` ç»“å°¾ä¸”ä¸ä»¥ `Node` å¼€å¤´çš„ç±»å‹
3. **ä»“å‚¨æœåŠ¡**: ä¸ä»¥ `Node`ã€`Base`ã€`Singleton` å¼€å¤´çš„ç±»å‹
4. **æ¥å£åŒ¹é…**: è‡ªåŠ¨åŒ¹é… `XxxService` ä¸ `IXxxService` æ¥å£
5. **ç”Ÿå‘½å‘¨æœŸ**: æ‰€æœ‰æœåŠ¡æ³¨å†Œä¸º `SingleInstance`

## ğŸ“ å‘½åè§„èŒƒæ€»ç»“

### è¡¨ç¤ºå±‚ (Scripts/Tests/Examples)
- **èŠ‚ç‚¹ç±»**: `TestNode`, `TestManager`
- **æ¥å£**: `ITestNode`, `ITestManager`
- **ç‰¹æ€§**: ä½¿ç”¨ `[GlobalClass]` æ ‡è®°å¯åœ¨ç¼–è¾‘å™¨ä¸­ä½¿ç”¨çš„ç±»

### åº”ç”¨å±‚ (TO.Apps.Services)
- **èŠ‚ç‚¹æœåŠ¡**: `NodeTestNodeService` (ä»¥ `Node` å¼€å¤´)
- **æ™®é€šæœåŠ¡**: `XxxService` (ä¸ä»¥ `Node` å¼€å¤´)

### åŸºç¡€è®¾æ–½å±‚ (TO.Infras.Repositories)
- **èŠ‚ç‚¹ä»“å‚¨**: `NodeTestNodeRepo` (å¯¹åº”èŠ‚ç‚¹æœåŠ¡)
- **å•ä¾‹ä»“å‚¨**: `TestManagerRepo` (å¯¹åº”å•ä¾‹ç®¡ç†å™¨)
- **æ™®é€šä»“å‚¨**: `XxxRepo` (ä¸ä»¥ç‰¹æ®Šå‰ç¼€å¼€å¤´)

### é¢†åŸŸå±‚æ¥å£ (TO.Domains.Models.Repositories.Abstractions)
- **èŠ‚ç‚¹ä»“å‚¨æ¥å£**: `INodeTestNodeRepo`
- **å•ä¾‹ä»“å‚¨æ¥å£**: `ITestManagerRepo`
- **èŠ‚ç‚¹æ¥å£**: `ITestNode`, `ITestManager`

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åˆ›å»ºæ–°çš„èŠ‚ç‚¹æœåŠ¡

1. **åˆ›å»ºèŠ‚ç‚¹æ¥å£** (TO.Nodes.Abstractions)
   ```csharp
   public interface IMyNode : INode
   {
       // èŠ‚ç‚¹ç‰¹å®šæ–¹æ³•
   }
   ```

2. **åˆ›å»ºè¡¨ç¤ºå±‚èŠ‚ç‚¹** (Scripts)
   ```csharp
   [GlobalClass]
   public partial class MyNode : Node, IMyNode
   {
       public ILifetimeScope? NodeScope { get; set; }
       
       public override void _Ready()
       {
           NodeScope = NodeContexts.Instance.RegisterNode<IMyNode, NodeMyNodeRepo>(this);
       }
   }
   ```

3. **åˆ›å»ºåº”ç”¨å±‚æœåŠ¡** (TO.Apps.Services)
   ```csharp
   public class NodeMyNodeService
   {
       // æœåŠ¡å®ç°
   }
   ```

4. **åˆ›å»ºåŸºç¡€è®¾æ–½å±‚ä»“å‚¨** (TO.Infras.Repositories)
   ```csharp
   public class NodeMyNodeRepo : NodeRepo<IMyNode>, INodeMyNodeRepo
   {
       public NodeMyNodeRepo(IMyNode main)
       {
           Node = main;
           Register();
           ContextEvents.TriggerRegisterNode(this, ConfigureNodeScope);
       }
   }
   ```

5. **åˆ›å»ºä»“å‚¨æ¥å£** (TO.Domains.Models.Repositories.Abstractions)
   ```csharp
   public interface INodeMyNodeRepo : INodeRepo<IMyNode>
   {
       // ä»“å‚¨ç‰¹å®šæ–¹æ³•
   }
   ```

### åˆ›å»ºå•ä¾‹ç®¡ç†å™¨

1. **åˆ›å»ºç®¡ç†å™¨æ¥å£**
   ```csharp
   public interface IMyManager : INode
   {
       // ç®¡ç†å™¨æ–¹æ³•
   }
   ```

2. **åˆ›å»ºè¡¨ç¤ºå±‚ç®¡ç†å™¨**
   ```csharp
   public partial class MyManager : Node, IMyManager
   {
       public ILifetimeScope? NodeScope { get; set; }
       
       public override void _Ready()
       {
           Contexts.Contexts.Instance.RegisterNode<IMyManager>(this);
       }
   }
   ```

3. **åˆ›å»ºå•ä¾‹ä»“å‚¨**
   ```csharp
   public class MyManagerRepo : SingletonNodeRepo<IMyManager>, IMyManagerRepo
   {
       protected override void Init()
       {
           base.Init();
           // è‡ªå®šä¹‰åˆå§‹åŒ–é€»è¾‘
       }
   }
   ```

4. **åœ¨ NodeRegister ä¸­æ·»åŠ æ³¨å†Œé€»è¾‘**
   
   **æ–‡ä»¶ä½ç½®**: `TO.Domains.Models.Repositories.Abstractions\Nodes\NodeRegister.cs`
   
   ```csharp
   public bool Register<T>(T node) where T : INode
   {
       return node switch
       {
           // ç°æœ‰çš„å•ä¾‹æ³¨å†Œ
           ITestManager testManager => testManagerRepo.Register(testManager),
           IUIManager uiManager => uiManagerRepo.Register(uiManager),
           IAudioManager audioManager => audioManagerRepo.Register(audioManager),
           ISaveManager saveManager => saveManagerRepo.Register(saveManager),
           ISceneManager sceneManager => sceneManagerRepo.Register(sceneManager),
           
           // æ–°å¢çš„ç®¡ç†å™¨æ³¨å†Œ
           IMyManager myManager => myManagerRepo.Register(myManager),
           
           _ => throw new ArgumentException($"æš‚ä¸æ”¯æŒçš„å•ä¾‹èŠ‚ç‚¹ï¼š{typeof(T).Name}")
       };
   }
   ```
   
   **é‡è¦æé†’**: æ¯å½“åˆ›å»ºæ–°çš„å•ä¾‹ç®¡ç†å™¨æ—¶ï¼Œéƒ½å¿…é¡»ï¼š
   - åœ¨ `NodeRegister` æ„é€ å‡½æ•°ä¸­æ³¨å…¥å¯¹åº”çš„ä»“å‚¨æ¥å£
   - åœ¨ `Register` æ–¹æ³•çš„ switch è¡¨è¾¾å¼ä¸­æ·»åŠ å¯¹åº”çš„ case åˆ†æ”¯
   - ç¡®ä¿ä»“å‚¨æ¥å£å’Œå®ç°ç±»å·²æ­£ç¡®åˆ›å»ºå¹¶æ³¨å†Œåˆ° DI å®¹å™¨ä¸­

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘½åä¸€è‡´æ€§**: ç¡®ä¿æœåŠ¡å’Œä»“å‚¨çš„å‘½åéµå¾ªçº¦å®šï¼Œä»¥ä¾¿è‡ªåŠ¨æ³¨å†Œç”Ÿæ•ˆ
2. **æ¥å£å®ç°**: æ‰€æœ‰èŠ‚ç‚¹éƒ½å¿…é¡»å®ç°å¯¹åº”çš„æ¥å£
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: èŠ‚ç‚¹æœåŠ¡ä¸ä»“å‚¨çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç»‘å®šçš„
4. **ç¨‹åºé›†å¼•ç”¨**: ç¡®ä¿ç›¸å…³ç¨‹åºé›†èƒ½å¤Ÿè¢«æ­£ç¡®åŠ è½½
5. **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œé¿å…ç›´æ¥å¼•ç”¨å…¶ä»–å±‚çš„å…·ä½“å®ç°
6. **âš ï¸ éèŠ‚ç‚¹æœåŠ¡æ„é€ å‡½æ•°**: åº”ç”¨å±‚ä¸­éèŠ‚ç‚¹çš„æœåŠ¡å¦‚æœæ„é€ å‡½æ•°ä¸­éœ€è¦æ‰§è¡Œé€»è¾‘ä»£ç ï¼Œå¿…é¡»åœ¨ `TO.Contexts\Contexts.cs` çš„æ„é€ å‡½æ•°ä¸­æ‰‹åŠ¨è§£æè¯¥æœåŠ¡ï¼ˆå¦‚ `Container.Resolve<IYourService>()`ï¼‰ï¼Œå¦åˆ™æ„é€ å‡½æ•°ä¸­çš„é€»è¾‘ä»£ç ä¸ä¼šè¢«æ‰§è¡Œã€‚è¿™æ˜¯å› ä¸º DI å®¹å™¨é‡‡ç”¨å»¶è¿ŸåŠ è½½ç­–ç•¥ï¼Œåªæœ‰åœ¨æ˜¾å¼è§£ææ—¶æ‰ä¼šåˆ›å»ºå®ä¾‹å¹¶æ‰§è¡Œæ„é€ å‡½æ•°
7. **ğŸ”´ èŠ‚ç‚¹æœåŠ¡å±‚çº§é™åˆ¶**: 
   - **æ™®é€šèŠ‚ç‚¹**: åªèƒ½åœ¨åº”ç”¨å±‚(`TO.Apps.Services`)åˆ›å»ºæœåŠ¡ï¼Œé¢†åŸŸå±‚ä¸­çš„èŠ‚ç‚¹æœåŠ¡ä¸ä¼šè¢«è‡ªåŠ¨æ³¨å†Œ
   - **èŠ‚ç‚¹ç®¡ç†å™¨**: å¯ä»¥åŒæ—¶åœ¨é¢†åŸŸå±‚å’Œåº”ç”¨å±‚åˆ›å»ºæœåŠ¡
   - **è¿è§„åæœ**: åœ¨é¢†åŸŸå±‚åˆ›å»ºæ™®é€šèŠ‚ç‚¹æœåŠ¡å°†å¯¼è‡´è¯¥æœåŠ¡æ— æ³•è¢«ä¾èµ–æ³¨å…¥å®¹å™¨è¯†åˆ«å’Œæ³¨å†Œ

## ğŸ“š æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ç¤ºä¾‹ä»£ç å’Œè‡ªåŠ¨æ³¨å†Œè§„èŒƒï¼Œæ¶µç›–äº†ä»è¡¨ç¤ºå±‚åˆ°åŸºç¡€è®¾æ–½å±‚çš„å®Œæ•´æ¶æ„ã€‚é€šè¿‡éµå¾ªè¿™äº›è§„èŒƒï¼Œå¯ä»¥ç¡®ä¿ï¼š

- **ä¸€è‡´æ€§**: ç»Ÿä¸€çš„å‘½åå’Œç»“æ„è§„èŒƒ
- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„åˆ†å±‚æ¶æ„å’Œä¾èµ–å…³ç³»
- **æ‰©å±•æ€§**: åŸºäºçº¦å®šçš„è‡ªåŠ¨æ³¨å†Œæœºåˆ¶
- **ç±»å‹å®‰å…¨**: å¼ºç±»å‹çš„ä¾èµ–æ³¨å…¥å’Œæ¥å£çº¦æŸ

åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¯·ä¸¥æ ¼éµå¾ªè¿™äº›è§„èŒƒï¼Œä»¥ä¿è¯ä»£ç è´¨é‡å’Œé¡¹ç›®çš„é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åŸºäºAutofacçš„å€’ç½®èŠ‚ç‚¹å±‚å®ç°æ–¹æ¡ˆ](./åŸºäºAutofacçš„å€’ç½®èŠ‚ç‚¹å±‚å®ç°æ–¹æ¡ˆ.md)
- [GodotC#çš„DDDæ¡†æ¶ç»“æ„](./GodotC#çš„DDDæ¡†æ¶ç»“æ„.md)
- [åœºæ™¯æ–‡ä»¶åˆ›å»ºè§„èŒƒä¸ä¾èµ–æ³¨å…¥è¯´æ˜](./åœºæ™¯æ–‡ä»¶åˆ›å»ºè§„èŒƒä¸ä¾èµ–æ³¨å…¥è¯´æ˜.md)
- [äº‹ä»¶æ€»çº¿ç³»ç»Ÿä½¿ç”¨è§„èŒƒ](./äº‹ä»¶æ€»çº¿ç³»ç»Ÿä½¿ç”¨è§„èŒƒ.md)